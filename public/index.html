<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OwO test</title>
  <script defer src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
  <style>
    body {
      background-color: #181818;
      margin: 0;
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
      font-family: Arial, Helvetica, sans-serif;
    }

    a {
      color: #1890ff;
      text-decoration: none;
    }

    a:hover {
      color: #1890ff;
      text-decoration: underline;
      cursor: pointer;
    }

    nav {
      background-color: #303030;
      padding: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .menu-link {
      display: inline-block;
      color: #fff;
      text-decoration: none;
      padding: 15px 20px;
      font-size: 20pt;
      transition: background-color 0.3s ease;
    }

    .menu-link:hover {
      background-color: #555;
    }

    .menu-link:active {
      background-color: #1890ff;
      text-decoration: none;
    }

    .h-entry {
      margin-left: 10%;
      margin-right: 10%;
      margin-bottom: 20px;
      background-color: #303030;
      border-radius: 8px;
      padding: 20px;
    }

    .h-entry h1 {
      text-align: center;
      font-size: 24pt;
    }

    .h-entry h2 {
      text-align: center;
      font-size: 20pt;
    }

    .h-entry h3,
    .h-entry h4,
    .h-entry h5,
    .h-entry h6 {
      text-align: center;
      font-size: 18pt;
    }

    .h-entry p {
      font-size: 16pt;
    }

    @media (max-width: 768px) {
      .menu-link {
        font-size: 14pt;
      }

      .h-entry h1 {
        font-size: 16pt;
      }

      .h-entry h2 {
        font-size: 14pt;
      }

      .h-entry h3,
      .h-entry h4,
      .h-entry h5,
      .h-entry h6 {
        font-size: 12pt;
      }

      .h-entry p {
        font-size: 10pt;
      }
    }
  </style>
</head>

<body>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const origin = document.location.origin;
      // https://pluribus.me/s/username/sitename/path/to/page.html --> https://pluribus.me/s/username/sitename
      const basePath = document.location.pathname.split('/').slice(0, 4).join("/");
      const baseUrl = `${origin}${basePath}`;
      await createMenubar(baseUrl);
      await fetchPageContent(baseUrl);
    });

    async function createMenubar(baseUrl) {
      const menubar = document.createElement("nav");
      menubar.style.width = "100%";
      const pagesJsonLink = `${baseUrl}/pages.json`;

      const content = await fetch(pagesJsonLink, {
        method: "GET",
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Cache-Control": "no-cache, must-revalidate",
        },
      });
      if (content.ok) {
        const pagesJson = await content.json();
        for (const page of pagesJson) {
          let relPage;
          if (page === "index") {
            relPage = "";
          } else {
             relPage = `${page}.html`
          }
          const pageLink = document.createElement("a");
          pageLink.classList.add("menu-link");
          pageLink.href = `${baseUrl}/${relPage}`;
          pageLink.textContent = page;
          menubar.appendChild(pageLink);
        }
        document.body.appendChild(menubar);
      }
    }

    async function fetchPageContent(baseUrl) {
      marked.setOptions({
        gfm: true,
        breaks: true,
      });

      // https://pluribus.me/s/username/sitename/path/to/page.html --> path/to/page
      var pathname = window.location.pathname.split('/').slice(4).join("/").replace(".html", "");
      if (!pathname) {
        pathname = "index";
      }

      var panel = document.createElement("main");
      const errorMessage = "Could not fetch page content<br><br>O_o";
      try {
        let fetchPathName = `${baseUrl}/${pathname}.md`;
        const content = await fetch(fetchPathName, {
          method: "GET",
          headers: {
            "Access-Control-Allow-Origin": "*",
            "Cache-Control": "no-cache, must-revalidate",
          },
        });
        if (content.ok) {
          const text = await content.text();
          const parsedMarkdown = await marked.parse(text, breaks = true);
          const sanitizedMarkdown = DOMPurify.sanitize(parsedMarkdown);

          const markdownSections = sanitizedMarkdown.split('<hr>');
          for (let i = 0; i < markdownSections.length; i++) {
            const section = markdownSections[i].trim();
            if (section) {
              const sectionArticle = document.createElement('article');
              sectionArticle.classList.add('h-entry');
              sectionArticle.innerHTML = section;
              panel.appendChild(sectionArticle);
            }
          }
        } else {
          throw new RuntimeException(errorMessage);
        }
      } catch (error) {
        panel.innerHTML = errorMessage;
      }

      document.body.appendChild(panel);
    }
  </script>
<!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "961ff68dd5804b81b88ac6a4087df32e"}'></script><!-- Cloudflare Pages Analytics --></body>

</html>